name: Clinic-Core CI

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: self-hosted

    services:
      postgres:
        image: postgres:18.1
        env:
          POSTGRES_DB: clinic_core_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: takudzwa2025
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:takudzwa2025@localhost:5432/clinic_core_db
      NODE_ENV: test

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend dependencies
        working-directory: backend
        run: npm install

      - name: Run backend tests
        working-directory: backend
        run: npm test

  frontend-checks:
    name: Frontend Lint & Build
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: apps/web
        run: npm install

      - name: Lint frontend
        working-directory: apps/web
        run: npm run lint

      - name: Build frontend
        working-directory: apps/web
        run: npm run build

  ci-issue-manager:
    name: CI Issue Automation
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-checks]
    if: always()

    permissions:
      issues: write
      contents: read

    steps:
      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Find existing CI failure issue
        id: find_issue
        run: |
          ISSUE_NUMBER=$(gh issue list \
            --label ci \
            --label automated \
            --search "CI Failure" \
            --state open \
            --json number \
            --jq '.[0].number')

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: Create CI failure issue (no duplicates)
        if: contains(needs.*.result, 'failure') && steps.find_issue.outputs.issue_number == ''
        run: |
          gh issue create \
            --title "CI Failure: ${{ github.ref_name }}" \
            --body "ðŸš¨ **CI pipeline failed**

          **Branch:** \`${{ github.ref_name }}\`
          **Commit:** \`${{ github.sha }}\`
          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          This issue was automatically created by GitHub Actions." \
            --label ci \
            --label bug \
            --label automated

      - name: Close CI issue when pipeline recovers
        if: ${{ !contains(needs.*.result, 'failure') && steps.find_issue.outputs.issue_number != '' }}
        run: |
          gh issue close ${{ steps.find_issue.outputs.issue_number }} \
            --comment "âœ… CI is green again. Closing issue automatically."
